# OpenClaw 浏览器自动化实现原理详解

> 生成时间：2026-02-10

---

## 目录

1. [核心架构概述](#核心架构概述)
2. [浏览器控制服务](#浏览器控制服务)
3. [快照系统详解](#快照系统详解)
4. [AI理解页面的方式](#ai理解页面的方式)
5. [完整自动化流程](#完整自动化流程)
6. [数据格式详解](#数据格式详解)
7. [实际案例分析](#实际案例分析)
8. [关键技术点](#关键技术点)

---

## 1. 核心架构概述

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      OpenClaw Agent                          │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                   用户指令                            │   │
│   └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│   ┌─────────────────────────────────────────────────────┐   │
│   │               决策层 (Agent Brain)                    │   │
│   │   • 解析用户意图                                      │   │
│   │   • 判断是否需要浏览器                                │   │
│   │   • 规划操作步骤                                      │   │
│   └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                  browser 工具                         │   │
│   │   • open: 打开URL                                     │   │
│   │   • snapshot: 页面快照                                │   │
│   │   • screenshot: 截图                                  │   │
│   │   • act: 执行UI操作                                   │   │
│   └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│   ┌─────────────────────────────────────────────────────┐   │
│   │             浏览器控制服务 (Browser Relay)            │   │
│   │   • Chrome 扩展 + WebSocket                           │   │
│   │   • Playwright 底层引擎                               │   │
│   └─────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                     真实浏览器                         │   │
│   │   • Chrome / Chromium                                │   │
│   │   • 实际渲染页面                                      │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 判断是否需要浏览器的逻辑

```
用户指令输入
     │
     ▼
┌────────────────────────┐
│  关键词/意图检测        │
└────────────────────────┘
     │
     ├───▶ "打开" + URL → 需要浏览器
     ├───▶ "点击" + 按钮/链接 → 需要浏览器
     ├───▶ "搜索" + 网站名 → 需要浏览器
     ├───▶ "填写" + 表单 → 需要浏览器
     ├───▶ "截图" + 页面 → 需要浏览器
     │
     ├───▶ "今天天气" → 可能不需要（可API查询）
     ├───▶ "帮我写代码" → 不需要
     ├───▶ "计算数学题" → 不需要
     │
     ▼
┌────────────────────────┐
│  输出操作计划           │
└────────────────────────┘
```

**OpenClaw 的决策依据：**

| 用户指令类型 | 示例 | 是否需要浏览器 |
|-------------|------|---------------|
| 网站操作 | "打开百度" | ✅ 需要 |
| 页面内容获取 | "获取页面标题" | ✅ 需要 |
| 交互操作 | "点击登录按钮" | ✅ 需要 |
| 信息搜索 | "搜索B站UP主" | ⚠️ 优先API，失败则浏览器 |
| 纯粹计算 | "1+1=?" | ❌ 不需要 |
| 文件操作 | "读取config.json" | ❌ 不需要 |

---

## 2. 浏览器控制服务

### 2.1 服务启动流程

```bash
# 用户启动 OpenClaw Gateway
openclaw gateway start
     │
     ▼
┌─────────────────────────────────────────┐
│  Gateway 初始化                          │
│  • 加载配置                              │
│  • 启动 WebSocket 服务器                  │
│  • 准备浏览器控制服务                     │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  Chrome 扩展检测                         │
│  • 检查 "OpenClaw Browser Relay" 扩展    │
│  • 如果未安装，提示用户安装               │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  用户操作                                │
│  • 用户点击扩展图标                      │
│  • 扩展连接到 WebSocket                   │
│  • 建立双向通信通道                       │
└─────────────────────────────────────────┘
```

### 2.2 两种浏览器模式

#### 模式1：Chrome 扩展模式 (profile: "chrome")

```
┌─────────────────────────────────────────────────────────────┐
│                        Chrome 浏览器                          │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │        OpenClaw Browser Relay 扩展                   │   │
│   │   • WebSocket 客户端                                  │   │
│   │   • Playwright 绑定                                   │   │
│   │   • DOM 拦截器                                        │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                   用户网页                            │   │
│   │   • 正常渲染                                         │   │
│   │   • OpenClaw 通过扩展控制                            │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**优点：**
- 用户可同时使用浏览器
- 可控制已打开的标签页
- 体验更自然

**缺点：**
- 需要安装扩展
- 需要用户手动连接

#### 模式2：隔离浏览器模式 (profile: "openclaw")

```
┌─────────────────────────────────────────────────────────────┐
│                    OpenClaw 管理的浏览器                      │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Playwright 控制层                        │   │
│   │   • 无头模式 (headless) 或 有头模式                    │   │
│   │   • 独立 Chrome 进程                                  │   │
│   │   • 完全隔离                                          │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                   临时网页                            │   │
│   │   • OpenClaw 专用                                    │   │
│   │   • 会话结束自动清理                                  │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**优点：**
- 无需安装扩展
- 完全隔离，安全
- 适合自动化任务

**缺点：**
- 独立进程，资源消耗
- 用户看不到实际操作

---

## 3. 快照系统详解

### 3.1 快照是什么？

快照是浏览器页面的**结构化描述**，不是简单的截图，而是包含：

1. **页面标题和URL**
2. **所有可交互元素的层次结构**
3. **每个元素的属性**（role、name、id、class等）
4. **元素之间的关系**（父子、兄弟）

### 3.2 两种快照格式

#### 格式1：Role-based 快照 (refs: "role", 默认)

```json
{
  "role": "document",
  "name": "哔哩哔哩 (゜-゜)つロ 干杯~-bilibili",
  "children": [
    {
      "role": "banner",
      "children": [
        {
          "role": "link",
          "name": "首页",
          "children": []
        },
        {
          "role": "link", 
          "name": "番剧",
          "children": []
        }
      ]
    },
    {
      "role": "main",
      "children": [
        {
          "role": "heading",
          "name": "影视飓风"
        },
        {
          "role": "button",
          "name": "关注"
        }
      ]
    }
  ]
}
```

**特点：**
- 基于 ARIA 可访问性标准
- 每个元素都有 `role`（角色）
- 简洁，只包含交互元素
- AI 容易理解

#### 格式2：ARIA 快照 (refs: "aria")

```json
{
  "element": "root",
  "role": "document",
  "name": "哔哩哔哩 (゜-゜)つロ 干杯~-bilibili",
  "children": [
    {
      "element": "A",
      "role": "link",
      "name": "首页",
      "attributes": {
        "href": "//www.bilibili.com",
        "target": "_self"
      },
      "children": []
    },
    {
      "element": "INPUT",
      "role": "searchbox",
      "name": "搜索视频、番剧、UP主等",
      "attributes": {
        "placeholder": "搜索视频、番剧、UP主等",
        "type": "search",
        "maxlength": "100"
      }
    }
  ]
}
```

**特点：**
- 更详细，包含原生 HTML 标签
- 包含所有 HTML 属性
- 更接近底层 DOM
- 信息更丰富但更复杂

### 3.3 快照生成流程

```
browser.action: "snapshot"
     │
     ▼
┌─────────────────────────────────────────┐
│  Playwright 执行 JavaScript              │
│  • 遍历整个 DOM 树                        │
│  • 收集每个元素的可访问性信息              │
│  • 构建层次结构                           │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  元素过滤与映射                           │
│  • 过滤不可见元素                         │
│  • 过滤不可交互元素                       │
│  • 映射 role 和 name                     │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  转换为 JSON 树结构                      │
│  • 递归处理子元素                        │
│  • 添加唯一标识符（ref）                  │
└─────────────────────────────────────────┘
     │
     ▼
返回给 AI 分析
```

### 3.4 快照中的 ref 引用

每个元素都有一个唯一的 `ref`（引用），用于后续操作：

```json
{
  "role": "button",
  "name": "关注",
  "ref": "e12",    // ← 唯一标识符
  "children": []
}
```

**为什么需要 ref？**

| 问题 | 没有 ref | 有 ref |
|-----|---------|--------|
| 定位元素 | "第二个按钮"（不稳定） | `ref: "e12"`（稳定）|
| 跨操作 | 需要重新描述 | 直接引用 |
| 准确性 | 可能选错元素 | 精准定位 |

---

## 4. AI理解页面的方式

### 4.1 AI 接收到的信息

当 AI 调用 `browser.snapshot` 后，接收到的内容：

```
================================================================================
页面标题: 影视飓风-哔哩哔哩_bilibili
当前URL: https://space.bilibili.com/946974
================================================================================

快照树:

[0] document "影视飓风-哔哩哔哩_bilibili"
│
├── [1] banner
│   └── [2] link "首页"
│   └── [3] link "番剧"
│   └── [4] link "直播"
│   └── [5] link "游戏"
│   └── [6] link "漫画"
│
├── [7] navigation
│   └── [8] link "主页"
│   └── [9] link "视频"
│   └── [10] link "相簿"
│   └── [11] link "文集"
│   └── [12] link "全部动态"
│
└── [13] main
    ├── [14] heading "影视飓风"
    ├── [15] button "关注"
    ├── [16] button "私信"
    ├── [17] button "举报"
    ├── [18] staticText "1504.6万粉丝"
    └── [19] staticText "940个视频"
```

### 4.2 AI 的思考过程

```
AI 接收快照
     │
     ▼
┌─────────────────────────────────────────┐
│  步骤1: 理解用户意图                      │
│  "用户想要知道影视飓风的粉丝数"           │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  步骤2: 在快照中搜索相关信息              │
│  搜索关键词: "粉丝"                       │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  步骤3: 找到目标元素                      │
│  找到 [18] staticText "1504.6万粉丝"     │
└─────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────┐
│  步骤4: 规划下一步操作                    │
│  操作: 提取文本内容                       │
│  或: 返回给用户                           │
└─────────────────────────────────────────┘
```

### 4.3 AI 如何描述元素让人类理解

**AI 看到的：**
```json
{
  "role": "button",
  "name": "关注",
  "ref": "e15"
}
```

**AI 向用户描述：**
> "页面上有一个'关注'按钮（位于粉丝数上方）"

**翻译过程：**
```
role: "button"      → 按钮
name: "关注"        → 按钮上的文字
位置关系            → 在 main 区域，heading 下方
```

### 4.4 多轮交互示例

**第1轮：用户说"打开B站"**
```
AI → browser.open(url: "https://www.bilibili.com")
AI → browser.snapshot()
返回: 页面已打开，顶部有导航栏...
```

**第2轮：用户说"搜索影视飓风"**
```
AI 思考: 需要找到搜索框，输入"影视飓风"
AI → browser.snapshot()  // 重新获取快照
在快照中找到搜索框的 ref
AI → browser.act(
  request: {
    kind: "type",
    ref: "搜索框ref",
    text: "影视飓风"
  }
)
AI → browser.act(
  request: {
    kind: "press",
    key: "Enter"
  }
)
```

**第3轮：用户说"点击第一个结果"**
```
AI → browser.snapshot()  // 页面已变化，重新获取
找到搜索结果列表
AI → browser.act(
  request: {
    kind: "click",
    ref: "第一个链接ref"
  }
)
```

---

## 5. 完整自动化流程

### 5.1 流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户发起指令                                     │
│                         "帮我打开百度，搜索OpenClaw"                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           1. 意图理解与规划                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  • 识别需要浏览器操作                                                 │    │
│  │  • 分解任务:                                                         │    │
│  │    1. 打开百度                                                       │    │
│  │    2. 找到搜索框                                                     │    │
│  │    3. 输入 "OpenClaw"                                               │    │
│  │    4. 点击搜索按钮                                                   │    │
│  │    5. 等待结果                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           2. 打开目标网页                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  browser({                                                           │    │
│  │    action: "open",                                                   │    │
│  │    targetUrl: "https://www.baidu.com"                                │    │
│  │  })                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  浏览器控制服务收到请求                                               │    │
│  │  → 如果是 chrome 模式: 激活/创建标签页                               │    │
│  │  → 如果是 openclaw 模式: 启动新 Chrome 进程                          │    │
│  │  → 导航到目标 URL                                                    │    │
│  │  → 等待页面加载完成 (DOMContentLoaded)                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           3. 获取页面快照                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  browser({                                                           │    │
│  │    action: "snapshot",                                               │    │
│  │    refs: "role"  // 或 "aria"                                        │    │
│  │  })                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Playwright 执行页面分析                                             │    │
│  │  → 遍历 DOM 树                                                       │    │
│  │  → 计算每个元素的可见性和可交互性                                     │    │
│  │  → 构建可访问性树 (Accessibility Tree)                               │    │
│  │  → 添加 ref 标识符                                                   │    │
│  │  → 返回 JSON 结构                                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           4. AI 分析快照                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  AI 接收 JSON 树                                                     │    │
│  │  → 解析页面结构                                                      │    │
│  │  → 搜索目标元素 (搜索框)                                             │    │
│  │  → 找到 ref: "search-input-ref"                                     │    │
│  │  → 规划下一步操作                                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           5. 执行交互操作                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  browser({                                                           │    │
│  │    action: "act",                                                    │    │
│  │    request: {                                                        │    │
│  │      kind: "type",                                                   │    │
│  │      ref: "search-input-ref",                                        │    │
│  │      text: "OpenClaw"                                               │    │
│  │    }                                                                 │    │
│  │  })                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                       │
│                                     ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  浏览器控制服务执行操作                                               │    │
│  │  → 找到 ref 对应的 DOM 元素                                          │    │
│  │  → 模拟用户输入                                                       │    │
│  │  → 触发 input 事件                                                   │    │
│  │  → 返回操作结果                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           6. 点击搜索按钮                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  再次获取快照（页面可能变化）                                         │    │
│  │  → 找到搜索按钮                                                      │    │
│  │  → 执行点击操作                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           7. 等待并获取结果                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  等待页面加载                                                         │    │
│  │  → 获取新页面快照                                                     │    │
│  │  → 提取搜索结果                                                       │    │
│  │  → 返回给用户                                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 时序图

```
用户                    Agent                  Browser Service           Chrome
 │                        │                        │                      │
 │ "打开百度"             │                        │                      │
 │──────────────────────▶│                        │                      │
 │                        │ open(url)              │                      │
 │                        │───────────────────────▶│                      │
 │                        │                        │ new page              │
 │                        │                        │─────────────────────▶│
 │                        │                        │                      │◀─ load
 │                        │                        │◀─────────────────────│
 │                        │                        │                      │
 │                        │ snapshot()             │                      │
 │                        │───────────────────────▶│                      │
 │                        │                        │ analyze DOM           │
 │                        │                        │◀─────────────────────│
 │                        │                        │                      │
 │                        │ JSON Tree              │                      │
 │                        │◀───────────────────────│                      │
 │                        │                        │                      │
 │                        │ 分析: 找到搜索框        │                      │
 │                        │ type(text)             │                      │
 │                        │───────────────────────▶│                      │
 │                        │                        │ input DOM             │
 │                        │                        │─────────────────────▶│
 │                        │                        │                      │◀─ render
 │                        │                        │◀─────────────────────│
 │                        │                        │                      │
 │                        │ 点击搜索按钮            │                      │
 │                        │───────────────────────▶│                      │
 │                        │                        │ click DOM             │
 │                        │                        │─────────────────────▶│
 │                        │                        │                      │◀─ navigate
 │                        │                        │◀─────────────────────│
 │                        │                        │                      │
 │                        │ snapshot()             │                      │
 │                        │───────────────────────▶│                      │
 │                        │                        │                      │
 │                        │ 结果                   │                      │
 │◀───────────────────────│◀───────────────────────│                      │
 │                        │                        │                      │
```

---

## 6. 数据格式详解

### 6.1 浏览器工具完整参数

```typescript
interface BrowserParams {
  // 基础参数
  action: "status" | "start" | "stop" | "profiles" | "tabs" | "open" | 
          "focus" | "close" | "snapshot" | "screenshot" | "navigate" | 
          "console" | "pdf" | "upload" | "dialog" | "act";
  
  // 浏览器配置
  profile?: "chrome" | "openclaw";  // Chrome扩展模式或隔离模式
  target?: "sandbox" | "host" | "node";  // 浏览器位置
  
  // URL相关
  targetUrl?: string;  // 打开的URL
  
  // 快照相关
  refs?: "role" | "aria";  // 快照格式
  snapshotFormat?: "aria" | "ai";  // 快照输出格式
  
  // 元素定位
  selector?: string;  // CSS选择器
  element?: string;  // 元素描述
  
  // UI操作
  request?: {
    kind: "click" | "type" | "press" | "hover" | "drag" | 
          "select" | "fill" | "resize" | "wait" | "evaluate" | "close";
    ref?: string;  // 元素引用
    text?: string;  // 输入文本
    submit?: boolean;  // 提交表单
    doubleClick?: boolean;  // 双击
    slowly?: boolean;  // 慢速操作（动画）
    key?: string;  // 按键名称
    value?: string;  // 值
    values?: string[];  // 多选值
    targetId?: string;  // 目标ID
    startRef?: string;  // 拖拽起始
    endRef?: string;  // 拖拽结束
    timeMs?: number;  // 等待毫秒
  };
  
  // 截图/PDF
  type?: "png" | "jpeg";
  fullPage?: boolean;
  
  // 其他
  timeoutMs?: number;
}
```

### 6.2 快照数据完整示例

```json
{
  "title": "哔哩哔哩 (゜-゜)つロ 干杯~-bilibili",
  "url": "https://www.bilibili.com/",
  "tree": {
    "role": "document",
    "name": "哔哩哔哩 (゜-゜)つロ 干杯~-bilibili",
    "children": [
      {
        "role": "banner",
        "name": "",
        "children": [
          {
            "role": "link",
            "name": "首页",
            "ref": "e2",
            "children": []
          },
          {
            "role": "link",
            "name": "番剧",
            "ref": "e3",
            "children": []
          }
        ]
      },
      {
        "role": "navigation",
        "name": "主要导航",
        "children": []
      },
      {
        "role": "main",
        "name": "主要内容",
        "children": [
          {
            "role": "searchbox",
            "name": "搜索视频、番剧、UP主等",
            "ref": "e10",
            "attributes": {
              "placeholder": "搜索视频、番剧、UP主等",
              "type": "search"
            }
          },
          {
            "role": "button",
            "name": "搜索",
            "ref": "e11",
            "children": []
          }
        ]
      }
    ]
  }
}
```

### 6.3 UI操作请求示例

#### 点击操作
```json
{
  "request": {
    "kind": "click",
    "ref": "e15",
    "doubleClick": false,
    "submit": false
  }
}
```

#### 输入操作
```json
{
  "request": {
    "kind": "type",
    "ref": "e10",
    "text": "OpenClaw 是一个 AI 助手框架"
  }
}
```

#### 按键操作
```json
{
  "request": {
    "kind": "press",
    "key": "Enter"
  }
}
```

#### 悬停操作
```json
{
  "request": {
    "kind": "hover",
    "ref": "e20"
  }
}
```

#### 拖拽操作
```json
{
  "request": {
    "kind": "drag",
    "startRef": "e30",
    "endRef": "e31"
  }
}
```

#### 下拉选择
```json
{
  "request": {
    "kind": "select",
    "ref": "e40",
    "values": ["选项1", "选项2"]
  }
}
```

#### 等待操作
```json
{
  "request": {
    "kind": "wait",
    "timeMs": 2000
  }
}
```

---

## 7. 实际案例分析

### 案例1：完整的B站粉丝查询流程

#### 用户输入
> "打开B站，搜索影视飓风，看看有多少粉丝"

#### AI 操作日志

```
[1] browser({ action: "open", targetUrl: "https://www.bilibili.com" })
    → 打开B站首页

[2] browser({ action: "snapshot", refs: "role" })
    → 获取页面结构

[AI分析] 页面已加载，找到顶部导航栏和搜索框

[3] browser({ 
      action: "act", 
      request: { kind: "type", ref: "搜索框ref", text: "影视飓风" } 
    })
    → 在搜索框输入 "影视飓风"

[4] browser({ 
      action: "act", 
      request: { kind: "press", key: "Enter" } 
    })
    → 按回车搜索

[5] browser({ action: "snapshot", refs: "role" })
    → 获取搜索结果页

[AI分析] 找到搜索结果，第一个是官方账号

[6] browser({ action: "act", request: { kind: "click", ref: "第一个结果ref" } })
    → 点击进入影视飓风主页

[7] browser({ action: "snapshot", refs: "role" })
    → 获取主页快照

[AI分析] 在页面主体区域找到 "1504.6万粉丝"
```

#### 实际快照片段（粉丝数部分）

```json
{
  "role": "main",
  "children": [
    {
      "role": "heading",
      "name": "影视飓风"
    },
    {
      "role": "button",
      "name": "关注",
      "ref": "e15"
    },
    {
      "role": "button", 
      "name": "私信",
      "ref": "e16"
    },
    {
      "role": "staticText",
      "name": "1504.6万粉丝",
      "ref": "e18"
    },
    {
      "role": "staticText", 
      "name": "940个视频",
      "ref": "e19"
    }
  ]
}
```

### 案例2：表单填写和提交

#### 用户输入
> "打开知乎，注册一个新账号，邮箱用 test@example.com"

#### AI 操作流程

```
[1] browser({ action: "open", targetUrl: "https://www.zhihu.com" })
[2] browser({ action: "snapshot" })  // 分析页面
[3] browser({ action: "act", request: { kind: "click", ref: "注册按钮ref" } })
[4] browser({ action: "snapshot" })  // 获取注册表单
[5] browser({ action: "act", request: { kind: "type", ref: "邮箱输入框ref", text: "test@example.com" } })
[6] browser({ action: "act", request: { kind: "type", ref: "密码输入框ref", text: "xxx" } })
[7] browser({ action: "act", request: { kind: "click", ref: "注册提交按钮ref" } })
```

#### 表单快照示例

```json
{
  "role": "main",
  "children": [
    {
      "role": "form",
      "name": "注册",
      "children": [
        {
          "role": "textbox",
          "name": "邮箱",
          "ref": "e5",
          "attributes": { "type": "email", "required": true }
        },
        {
          "role": "textbox", 
          "name": "密码",
          "ref": "e6",
          "attributes": { "type": "password", "minlength": "6" }
        },
        {
          "role": "checkbox",
          "name": "我已阅读并同意",
          "ref": "e7"
        },
        {
          "role": "button",
          "name": "注册",
          "ref": "e8"
        }
      ]
    }
  ]
}
```

---

## 8. 关键技术点

### 8.1 Playwright 底层机制

```javascript
// Playwright 实际上是这样生成快照的

async function generateSnapshot(page) {
  // 1. 遍历 DOM
  const accessibilityTree = await page.evaluate(() => {
    function buildTree(node) {
      // 跳过隐藏元素
      if (isHidden(node)) return null;
      
      // 获取 ARIA 角色
      const role = getARIARole(node);
      const name = getARIAName(node);
      
      // 递归处理子元素
      const children = Array.from(node.children)
        .map(child => buildTree(child))
        .filter(child => child !== null);
      
      return {
        role,
        name,
        children,
        // ... 其他属性
      };
    }
    
    return buildTree(document.body);
  });
  
  return accessibilityTree;
}
```

### 8.2 Ref 引用稳定性

**问题：** 每次快照的 ref 可能会变吗？

**答案：** 在同一次快照树内稳定，跨快照可能变化

```
第一次 snapshot:
  button "关注" → ref: "e15"

第二次 snapshot (页面刷新后):
  button "关注" → ref: "e15" (可能相同，可能不同)
```

**解决方案：**
- 每次操作后重新获取快照
- 使用 `targetId` 保持对同一元素的引用

### 8.3 元素定位策略

AI 如何精确定位元素？

```javascript
// AI 的思考过程

// 1. 文字匹配
function findByText(snapshot, text) {
  // 递归搜索 name 包含 text 的元素
}

// 2. 角色过滤
function findByRole(snapshot, role) {
  // 搜索特定 role 的元素
}

// 3. 位置推理
function findNear(snapshot, referenceElement, direction) {
  // 找到 referenceElement 附近(direction方向)的元素
}

// AI 综合使用
const searchBox = findByRole(page, "searchbox");
const submitButton = findNear(page, searchBox, "below");
```

### 8.4 错误处理

```javascript
// 常见错误和应对

// 1. 元素不存在
{
  error: "元素 ref 'e15' 不存在",
  原因: "页面已刷新，ref 失效",
  解决: "重新获取快照"
}

// 2. 元素不可见
{
  error: "元素不可点击",
  原因: "元素可能被遮挡或隐藏",
  解决: "滚动到可见，或等待动画完成"
}

// 3. 页面未加载完成
{
  error: "操作超时",
  原因: "页面还在加载",
  解决: "添加 wait 操作"
}
```

### 8.5 性能优化

| 优化点 | 方法 | 效果 |
|-------|------|------|
| 减少快照次数 | 缓存快照，复用 | 减少延迟 |
| 增量更新 | 只更新变化的区域 | 降低开销 |
| 并行操作 | 不依赖顺序的操作同时执行 | 节省时间 |
| 智能等待 | 根据条件等待而非固定时间 | 快速响应 |

---

## 9. 总结

### 核心流程回顾

```
用户指令
    │
    ▼
┌─────────────┐
│ 意图理解     │ → 判断是否需要浏览器
└─────────────┘
    │
    ▼
┌─────────────┐
│ 打开页面     │ → browser.open()
└─────────────┘
    │
    ▼
┌─────────────┐
│ 获取快照     │ → browser.snapshot()
└─────────────┘
    │
    ▼
┌─────────────┐
│ AI 分析     │ → 理解页面结构，找到目标元素
└─────────────┘
    │
    ▼
┌─────────────┐
│ 执行操作     │ → browser.act() [click/type/hover等]
└─────────────┘
    │
    ▼
┌─────────────┐
│ 循环/结束   │ → 根据结果决定是否继续
└─────────────┘
```

### 关键要点

1. **快照是核心** — AI 通过快照理解页面，不是截图
2. **Ref 是桥梁** — 用 ref 而非文字描述来定位元素
3. **Role 简化理解** — ARIA role 让 AI 快速识别元素类型
4. **循环迭代** — 每步操作后重新快照，适应页面变化
5. **Playwright 底层** — 利用成熟的可访问性 API

---

*文档由 OpenClaw 自动生成*
